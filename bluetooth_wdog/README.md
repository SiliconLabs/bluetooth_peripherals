# Using Watchdog in Bluetooth Applications #

## Summary ##
In general, use the Watchdog to reset your device should the Bluetooth stack stop working for any reason. This software example will show you how to use a Watchdog timer in the Bluetooth application context.

## Gecko SDK version ##
v3.2 and newer

## Hardware Required ##
- [BRD4184A BG22 Thunderboard](https://www.silabs.com/development-tools/thunderboard/thunderboard-bg22-kit) for the Simplicity Studio 5 project

## Setup ##
There is an sls project that is available for the BG22 Thunderboard BRD4184A. Import the project into Simplicity Studio 5.

Steps to recreate the attached example:
1. Create a new Bluetooth SoC Empty project
2. Open the *.slcp file configurator and install the following components:
    - Platform > Peripheral > WDOG
    - Platform > Peripheral > RMU
3. Copy [app.c](src/app.c) into the project to overwrite the application

## How It Works ##
The Watchdog API is fairly simple. The Watchdog has to be initialized once after reset with WDOG_Init(&init) and it has to be fed from time to time before the Watchdog timer expires using WDOG_Feed(). In a Bluetooth context, the most suitable way to feed the Watchdog is by using an external event from the stack that is generated by the sleeptimer. When the sleeptimer expires, the callback function will signal the stack to generate an external event. If the stack stops working, the external event will not be generated and the Watchdog is not fed. Ultimately, this will reset the device.

To determine whether you recovered from a crash with a Watchdog reset or whether the device was reset normally, use the function RMU_ResetCauseGet();.

[UG434](https://www.silabs.com/documents/public/user-guides/ug434-bluetooth-c-soc-dev-guide-sdk-v3x.pdf) section 6.1 has information about the External Event.

The watchdog is initialized to timeout in ~2 seconds. The sleeptimer periodic timer is set to timeout in 1 second to feed the watchdog. There is test code in app_process() where holding the button on the BG22 thunderboard (GPIO port B, pin 1) will freeze the application, preventing the watchdog from being fed.

### Code Explanation

#### app_init()
For this example, app_init() in [app.c](src/app.c) checks the RMU reset cause before initializing the WDOG. Add any code when the reset cause is checked if your device is required to do anything special when a watchdog reset occurred. After the RMU reset cause is checked, the sleeptimer will start a periodic timer. The sleeptimer is already used by the power manager in Bluetooth projects.

The watchdog initialization struct contains the configuration fields that can be modified to your application.

#### app_process()
There is test code added here to freeze the application. When GPIO port B pin 1 is cleared (set to 0), the application will freeze. GPIO port B pin 1 is connected to the button on the BG22 thunderboard. That pin is also connected to one of the buttons if the WSTK radio board is used.

#### wdog_feeder_signal_cb()
This callback function is executed when the 1 second periodic sleeptimer times out. The callback calls [sl_bt_external_signal()](https://docs.silabs.com/bluetooth/3.2/group-sl-bt-utility-functions#gacc04b66d2bca0df7a4faf723d2419c40) to generate an event in the Bluetooth stack. The callback is executed in the context of an interrupt.

## .sls Projects Used ##
- bluetooth_wdog_bg22.sls

## Special Notes ##
There is a Bluetooth Radio Watchdog that can be installed through the *.slcp configurator. This Bluetooth Radio Watchdog is unrelated to the Watchdog Peripheral and is handled within the stack so no application-level intervention is required. This radio watchdog makes sure RAIL does not enter an unknown state. If the Bluetooth Radio Watchdog times out, then only the radio hardware layer is reset. The device does not reset when the Bluetooth Radio Watchdog times out. To enable this, open the *.slcp configurator and install Bluetooth > Controller > Bluetooth Radio Watchdog component.

For Gecko SDK 2.7 and older, the watchdog example can be found in this [article](https://docs.silabs.com/bluetooth/2.13/code-examples/peripheral/using-watchdog-in-bluetooth-applications).